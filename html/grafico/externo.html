<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráficos</title>
    <link rel="icon" type="image/png" href="../../img/logo1.png">
    <link rel="stylesheet" href="../../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header class="header">
  <img src="../../img/logob.png" alt="Logo">
  <h1><i class="ri-bar-chart-2-fill"></i> Gráficos</h1>
  <a class="back-btn" href="../suporte.html"><i class="ri-arrow-left-line"></i> Voltar</a>
</header>


    <div class="container">
        <aside class="sidebar">
            <nav class="menu">
                <a href="total.html" class="menu-item ">Total de Chamados</a>
                <a href="externoxinterno.html" class="menu-item">Externo x Interno</a>
                <a href="responsavel.html" class="menu-item ">Responsável</a>
                <a href="externo.html" class="menu-item active ">Externo - Serviço</a>
                <a href="interno.html" class="menu-item">Interno - servicos</a>
                <a href="causaexterno.html" class="menu-item">Causas</a>
            </nav>
        </aside>
<main class="main-content">
            <h2>Chamados Externos por (Serviços)</h2>
        <canvas id="chart" style="width: 100%; height: 100%;"></canvas>
</main>

<script>
    const sheetId = '1izuOnEttbuFD36JcsE5S8sFbl3L_y12f5LacQBG9x1w';
    const apiKey = 'AIzaSyA-aZjrMoRGcyuIlO-RbtaaFOZRHA4YGww';
    const range = 'Externo';
    const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

const fixedColors = {
      "Acesso ao Portal": "#3a86ff",
      "Certificadora": "#2a9d8f",
      "Subida de Operação": "#ffdd57",
      "Portal (Dúvidas)": "#faa307",
      "Apresentação do Portal": "#f3722c",
      "Arquivos": "#76B041",
      "Outros": "#adb5bd",
      "Homologação": "#8338ec",
      "Memorial de Cálculo": "#277da1",
      "API": "#70c1b3",
      "Arquivos (Retorno, Remessa, Boleto e Xml)": "#A52A2A"
    };





    let originalData = [];

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.values) {
                originalData = data.values;
                renderChart(originalData);
            } else {
                console.error('Nenhum dado encontrado na planilha.');
            }
        })
        .catch(error => console.error('Erro ao buscar dados:', error));

    function renderChart(data) {
        const headers = data[0];
        const sprintIndex = headers.indexOf("Sprint");
        const servicoIndex = headers.indexOf("Serviço");
        const counts = {};

        data.slice(1).forEach(row => {
            const sprint = row[sprintIndex];
            const servico = row[servicoIndex];
            if (!counts[sprint]) {
                counts[sprint] = {};
            }
            if (!counts[sprint][servico]) {
                counts[sprint][servico] = 0;
            }
            counts[sprint][servico]++;
        });

        let sprints = Object.keys(counts);
sprints.sort((a, b) => {
  const getNumber = str => parseInt(str.match(/\d+/)) || 0;
  return getNumber(b) - getNumber(a);
});

let servicos = Array.from(new Set(Object.values(counts).flatMap(sprint => Object.keys(sprint))));

// Garante que "Outros" sempre fique no final
servicos = servicos.filter(s => s !== "Outros").concat("Outros");

const dataset = servicos.map(servico => ({
    label: servico,
    data: sprints.map(sprint => counts[sprint][servico] || 0),
    backgroundColor: fixedColors[servico] || "#CCCCCC" // cor fallback caso falte alguma no fixedColors
}));


        const chartData = {
            labels: sprints,
            datasets: dataset
        };

        const ctx = document.getElementById('chart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                indexAxis: 'y', // horizontal
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                },
                scales: {
                    x: {
                        stacked: true,
                        beginAtZero: true
                    },
                    y: {
                        stacked: true
                    }
                }
            }
        });
    }



</script>
</body>
</html>
