<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chamados</title>
	 <link rel="icon" type="logo1/png" href="../img/logo1.png">
    <style>
        body, h2, p {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: url("../img/fundo.png") no-repeat center center;
            background-size: cover;
            position: relative;
        }

        header {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .logo {
            height: 100px;
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            color: #123d2a;
        }

        .btn-sair {
            padding: 6px 12px;
            background-color: #0d3d2a;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.3s;
        }

        .btn-sair:hover {
            background-color: #145c40;
        }

        .message-container {
            width: 400px;
            padding: 30px;
            background: rgba(240, 240, 240, 0.95);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        .message-container h2 {
            margin-bottom: 25px;
            color: #123d2a;
        }

        .btn {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 12px 0;
            background-color: #0d3d2a;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: 0.3s;
        }

        .btn:hover {
            background-color: #145c40;
        }
    </style>
</head>
<body>
    <header>
        <img src="../img/logob.png" class="logo" alt="Logo">
    </header>

<div class="user-info">
  <span id="userName"></span>
  <button class="logout-btn" onclick="sair()">Sair</button>
</div>



    <div class="message-container">
        <h2>Bem-vindo!</h2>
        <button class="btn" onclick="window.location.href='cadastrochamado.html'">Novo Chamado</button>
        <button class="btn" onclick="window.location.href='acompanhar.html'">Acompanhar Chamado</button>
        <button class="btn" onclick="window.location.href='adccedente.html'">Novo Cedente</button>
		    <button class="btn" onclick="window.location.href='grafico/total.html'">Gráficos</button>
    </div>

 <script>
    const tipoChamado = document.getElementById("tipoChamado");
    const form = document.getElementById("formChamado");
    const msg = document.getElementById("msg");
    const userName = document.getElementById("userName");
    const campoServico = document.getElementById("campoServico");
    const campoSistema = document.getElementById("campoSistema");
    const sprintInput = document.getElementById("sprint"); // Campo Sprint

    // Exibe nome do usuário no header
    userName.textContent = localStorage.getItem("nomeUsuario") || "Usuário";

    // Mostra/oculta campos conforme o tipo de chamado
    tipoChamado.addEventListener("change", () => {
      if (tipoChamado.value === "interno") {
        form.style.display = "block";
        campoSistema.style.display = "block";
        campoServico.style.display = "none";
      } else if (tipoChamado.value === "externo") {
        form.style.display = "block";
        campoServico.style.display = "block";
        campoSistema.style.display = "none";
      } else {
        form.style.display = "none";
        campoServico.style.display = "none";
        campoSistema.style.display = "none";
      }
    });

    function voltar() { window.history.back(); }
    function logout() { localStorage.removeItem("nomeUsuario"); window.location.href = "login.html"; }

    // ===== FUNÇÃO PARA DEFINIR SPRINT COM BASE NA DATA =====
    function definirSprint() {
      const hoje = new Date();
      const data = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

      const sprints = [
        { inicio: "2025-09-16", fim: "2025-09-29", sprint: "Sprint 136" },
        { inicio: "2025-09-30", fim: "2025-10-13", sprint: "Sprint 137" },
        { inicio: "2025-10-14", fim: "2025-10-27", sprint: "Sprint 138" },
        { inicio: "2025-10-28", fim: "2025-11-10", sprint: "Sprint 139" },
        { inicio: "2025-11-11", fim: "2025-11-24", sprint: "Sprint 140" },
        { inicio: "2025-11-25", fim: "2025-12-08", sprint: "Sprint 141" },
        { inicio: "2025-12-09", fim: "2025-12-22", sprint: "Sprint 142" },
        { inicio: "2025-12-23", fim: "2026-01-05", sprint: "Sprint 143" }
      ];

      function parseData(str) {
        const [ano, mes, dia] = str.split("-");
        return new Date(Number(ano), Number(mes) - 1, Number(dia));
      }

      let sprintAtual = "";
      sprints.forEach(periodo => {
        const inicio = parseData(periodo.inicio);
        const fim = parseData(periodo.fim);
        if (data >= inicio && data <= fim) {
          sprintAtual = periodo.sprint;
        }
      });

      sprintInput.value = sprintAtual || "Fora de Sprint definida";
    }

    // Executa quando a página carrega
    window.addEventListener("load", definirSprint);

    // ===== ENVIO DO FORM =====
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      msg.textContent = "Enviando...";
      msg.className = "";

      const formData = new FormData(form);
      const nomeUsuario = localStorage.getItem("nomeUsuario") || "Desconhecido";
      formData.append("responsavel", nomeUsuario);

      // Adiciona tipoChamado e Sprint
      formData.append("tipoChamado", tipoChamado.value);
      formData.append("sprint", sprintInput.value);

      const fileInput = document.getElementById('anexo');
      const file = fileInput.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function() {
          const base64Data = reader.result.split(',')[1];
          formData.append("anexoBase64", base64Data);
          formData.append("anexoNome", file.name);
          enviarForm(formData);
        };
        reader.readAsDataURL(file);
      } else {
        enviarForm(formData);
      }
    });

    function enviarForm(formData) {
      fetch("https://script.google.com/macros/s/AKfycbxFnFjOcxWQEAmAgXc367eptWcSfD4v3AJHlGjtewomYclk4C39rfYI-P8kO5nOHOTN2g/exec", {
        method: "POST",
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          msg.textContent = "Chamado cadastrado com sucesso!";
          form.reset();
          definirSprint(); // Recalcula sprint após resetar o formulário
        } else {
          msg.textContent = "Erro: " + data.message;
        }
      })
      .catch(err => {
        console.error(err);
        msg.textContent = "Erro na requisição.";
      });
    }
</script>

</body>
</html>
